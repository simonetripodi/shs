<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 | Generated by Apache Maven Doxia at May 28, 2012
 | Rendered using Apache Maven Fluido Skin 1.2.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple HttpServer - SHS - APIs</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido.min.js"></script>

    
      <meta name="author" content="Simone Tripodi" />
    <meta name="Date-Revision-yyyymmdd" content="20120528" />
    <meta http-equiv="Content-Language" content="en" />
    
        </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="http://github.com/simonetripodi/shs">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 100;"
        src="https://a248.e.akamai.net/assets.github.com/img/e6bef7a091f5f3138b8cd40bc3e114258dd68ddf/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Simple HttpServer</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 28 May 2012</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 0.1</li>
                      
                
                    
      
                  </ul>
      </div>

            <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                                    <h3>Simple HttpServer</h3>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Home">Home</a>
            </li>
                  <li class="none">
            <strong>APIs</strong>
          </li>
                  <li class="none">
                          <a href="core.html" title="Core">Core</a>
            </li>
                  <li class="none">
                          <a href="demo.html" title="Demo">Demo</a>
            </li>
                  <li class="none">
                          <a href="benchmarks.html" title="Benchmarks">Benchmarks</a>
            </li>
                  <li class="none">
                          <a href="developers.html" title="For Developers">For Developers</a>
            </li>
          </ul>
                        <h3>Project Documentation</h3>
                  <ul>
                                                                                                                                                                                                                                                                                                              <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
          </ul>
                      
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
        <div id="bodyColumn"  class="span9" >
                                  
            <!--  --><!-- Copyright (c) 2012 Simone Tripodi (simonetripodi[at]apache[dot]org) --><!--  --><!-- Permission is hereby granted, free of charge, to any person obtaining --><!-- a copy of this software and associated documentation files (the --><!-- "Software"), to deal in the Software without restriction, including --><!-- without limitation the rights to use, copy, modify, merge, publish, --><!-- distribute, sublicense, and/or sell copies of the Software, and to --><!-- permit persons to whom the Software is furnished to do so, subject to --><!-- the following conditions: --><!--  --><!-- The above copyright notice and this permission notice shall be --><!-- included in all copies or substantial portions of the Software. --><!--  --><!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, --><!-- EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF --><!-- MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND --><!-- NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE --><!-- LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION --><!-- OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION --><!-- WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. --><!--  --><div class="section"><h2>Simple HttpServer APIs<a name="Simple_HttpServer_APIs"></a></h2><p>The Simple HttpServer aims to provide web developers not just a server able to serve files over the HTTP protocol, but rather an API set to develop complete Web applications.</p><div class="section"><h3>The Http model<a name="The_Http_model"></a></h3><p>The HTTP model APIs takes inspiration from the Servlet model, simplifying it keeping off all the container related features, just pure HTTP protocol:</p><div class="section"><h4>UML class diagram<a name="UML_class_diagram"></a></h4><p>A detailed <a href="./images/http-apis.png">UML class diagram</a> will help to understand the model design.</p></div><div class="section"><h4>About classes organization<a name="About_classes_organization"></a></h4><p>Main entities are the <a href="./apidocs/org/nnsoft/shs/http/Request.html">Request</a> and <a href="./apidocs/org/nnsoft/shs/http/Response.html">Response</a>: they both are arguments of the <a href="./apidocs/org/nnsoft/shs/http/RequestHandler.html">RequestHandler</a> which is the entity responsible for the HTTP negotiation. A commodity <a href="./apidocs/org/nnsoft/shs/http/BaseRequestHandler.html">BaseRequestHandler</a> is provided in order to simplify the HTTP method handling, such as <tt>GET</tt> or <tt>POST</tt>, where users can implement the interested method handling.</p><p>Both <tt>Request</tt> and <tt>Response</tt> manipulate HTTP Headers as a <a href="./apidocs/org/nnsoft/shs/collections/MultiValued.html">MultiValued</a> collection, a read-only key-value data structure where for each key can be associated more than one value. <tt>Request</tt> query string parameters and form-urlencoded parameters are implemented as <tt>MultiValued</tt> as well.</p><p>So, in order to implement their own web applications, users can start extending a <tt>BaseRequestHandler</tt>; the code snippet below shows how to implement a simple handler that provides static files found in a region in the File System, that can be requested via the HTTP <tt>GET</tt> method.</p><div class="source"><pre class="prettyprint">public final class FileRequestHandler
    extends BaseRequestHandler
{

    private final File baseDir;

    public FileRequestHandler( File baseDir )
    {
        this.baseDir = baseDir;
    }

    @Override
    protected void get( final Request request, final Response response )
        throws IOException
    {
        File requested = new File( baseDir, request.getPath() );
        if ( !requested.exists() )
        {
            response.setStatus( Response.Status.NOT_FOUND );
            return;
        }

        if ( requested.isDirectory() )
        {
            requested = new File( requested, &quot;index.html&quot; );
        }

        if ( requested.exists() )
        {
            response.setStatus( Response.Status.OK );
            response.setBody( new FileResponseBodyWriter( requested ) ); // a special writer that streams the file
        }
        else
        {
            response.setStatus( Response.Status.NOT_FOUND );
        }
    }

}</pre></div></div></div><div class="section"><h3>The Server interfaces<a name="The_Server_interfaces"></a></h3><p>One of the Simple HttpServer ambitions is eliminating the boilerplate code to configure server instances, keeping off from the core implementation plain old textual configuration files, such as Properties or XML, and letting the server be configured with a pure Java mini EDSL (that of course can be proxed by textual representations, such as Properties, XML, JSON, YAML, ...).</p><div class="section"><h4>UML class diagram<a name="UML_class_diagram"></a></h4><p>A detailed <a href="./images/configuration.png">UML class diagram</a> will help to understand the model design.</p></div><div class="section"><h4>About classes organization<a name="About_classes_organization"></a></h4><p>Users implement <a href="./apidocs/org/nnsoft/shs/HttpServerConfiguration.html">HttpServerConfiguration</a>, the <a href="./apidocs/org/nnsoft/shs/HttpServer.html">HttpServer</a> passes a <a href="./apidocs/org/nnsoft/shs/HttpServerConfigurator.html">HttpServerConfigurator</a> to user configuration, and user configuration uses the configurator to map path patterns to <a href="./apidocs/org/nnsoft/shs/http/RequestHandler.html">RequestHandler</a>s.</p><div class="source"><pre class="prettyprint">public class MyServerConfiguration
    implements HttpServerConfiguration
{

    private final File siteDir = new File( System.getProperty( &quot;user.dir&quot; ), &quot;site&quot; );

    public void configure( HttpServerConfigurator configurator )
    {
        configurator.bindServerToHost( &quot;localhost&quot; );
        configurator.bindServerToPort( 8080 );
        configurator.serveRequestsWithThreads( 10 );
        configurator.sessionsHaveMagAge( 60 * 60 );
        configurator.keepAliveConnectionsHaveTimeout( 5 );

        configurator.serve( &quot;/*&quot; ).with( new FileRequestHandler( siteDir ) );
        configurator.when( Response.Status.NOT_FOUND ).serve( new File( siteDir, &quot;404.html&quot; ) );
        configurator.when( Response.Status.INTERNAL_SERVER_ERROR ).serve( new File( siteDir, &quot;500.html&quot; ) );
    }

}</pre></div><p>The configuration allows users specify:</p><ul><li>Server related data, such as the binding host and port, number of threads to serve requests, HTTP session max age and the Keep Alive timeout;</li><li>The handlers that have to be invoked when requesting paths - <tt>web.xml</tt> syntax supported!</li><li>The default response has to be provided when response provides a specific response status.<p>DRY (Don't Repeat Yourself): Repeating <tt>configurator</tt> over and over for each configure step can get a little tedious. The Simple HttpServer package provides a support class named <a href="./apidocs/org/nnsoft/shs/AbstractHttpServerConfiguration.html">AbstractHttpServerConfiguration</a> which implicitly gives you access to <tt>HttpServerConfigurator</tt>'s methods.</p><p>For example, extending <tt>AbstractHttpServerConfiguration</tt> and rewrite the above binding as:</p><div class="source"><pre class="prettyprint">public class MyServerConfiguration
    extends AbstractHttpServerConfiguration
{

    private final File siteDir = new File( System.getProperty( &quot;user.dir&quot; ), &quot;site&quot; );

    @Override
    protected void configure()
    {
        bindServerToHost( &quot;localhost&quot; );
        bindServerToPort( 8080 );
        serveRequestsWithThreads( 10 );
        sessionsHaveMagAge( 60 * 60 );
        keepAliveConnectionsHaveTimeout( 5 );

        serve( &quot;/*&quot; ).with( new FileRequestHandler( siteDir ) );
        when( Response.Status.NOT_FOUND ).serve( new File( siteDir, &quot;404.html&quot; ) );
        when( Response.Status.INTERNAL_SERVER_ERROR ).serve( new File( siteDir, &quot;500.html&quot; ) );
    }

}</pre></div><p>I'll use this syntax throughout the rest of the guide.</p><p>We can break <tt>HttpServer</tt>'s lifecycle down into three distinct stages: <i>init</i>, <i>runtime</i> and <i>stop</i>:</p></li><li>during the <i>init</i> phase, the Server warms up his engine according to the passed configuration; a typical pattern would be:<div class="source"><pre class="prettyprint">final HttpServerConfiguration configuration = new MyServerConfiguration();

final HttpServer httpServer = ... //let's see how to obtain an HttpServer instance in the core module

try
{
    httpServer.init( configuration );
}
catch ( InitException ie )
{
    logger.error( &quot;Server cannot be initialized&quot;, ie );
}</pre></div></li><li>the server switches to the <i>runtime</i> phase when the <tt>start()</tt> method is invoked; please note that <tt>start()</tt> is a blocking method, so all the checks/interruption have to be performed by a monitoring separated thread:<div class="source"><pre class="prettyprint">try
{
    httpServer.start();
}
catch ( RunException re )
{
    logger.error( &quot;Server cannot be started&quot;, re );
}</pre></div></li><li>server status can be monitored by invoking the <tt>getStatus()</tt> method: maybe the server accidentally crashed, so a monitor could re-init it or send alarms:<div class="source"><pre class="prettyprint">final HttpServer httpServer = ... 
httpServer.init( configuration );
httpServer.start();

new Thread()
{

    public void run()
    {
        if ( HttpServer.Status.STOPPED == httpServer.getStatus() )
        {
            sendAlertMail();
        }
        else
        {
            noOp();
        }
    }

}.start();</pre></div></li><li>server can be stopped inside the JVM ShutdownHook thread, i.e.: <div class="source"><pre class="prettyprint">Runtime.getRuntime().addShutdownHook( new Thread()
{

    public void run()
    {
        try
        {
            httpServer.stop();
        }
        catch ( ShutdownException e )
        {
            logger.error( &quot;Execution terminated with errors&quot;, se );
        }
    }

}</pre></div></li></ul></div></div></div><div class="section"><h2>Maven Users<a name="Maven_Users"></a></h2><p>Apache Maven users can include APIs artifact by including the following dependency:</p><div class="source"><pre class="prettyprint">  &lt;dependencies&gt;
    ...
    &lt;dependency&gt;
      &lt;groupId&gt;org.99soft.shs&lt;/groupId&gt;
      &lt;artifactId&gt;shs-api&lt;/artifactId&gt;
      &lt;version&gt;0.1&lt;/version&gt;
      &lt;scope&gt;provided&lt;/scope&gt;
    &lt;/dependency&gt;
    ...
  &lt;/dependencies&gt;</pre></div><p>APIs can be included in <i>provided</i> scope since the SHS runtime already brings them. </p></div>
                  </div>
            </div>
      
    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span16">Copyright &copy;                    2012
                        <a href="http://people.apache.org/~simonetripodi/">Simone Tripodi</a>.
            All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
