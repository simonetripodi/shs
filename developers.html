<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 | Generated by Apache Maven Doxia at May 28, 2012
 | Rendered using Apache Maven Fluido Skin 1.2.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple HttpServer - SHS - Core implementation</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido.min.js"></script>

    
      <meta name="author" content="Simone Tripodi" />
    <meta name="Date-Revision-yyyymmdd" content="20120528" />
    <meta http-equiv="Content-Language" content="en" />
    
        </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="http://github.com/simonetripodi/shs">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 100;"
        src="https://a248.e.akamai.net/assets.github.com/img/e6bef7a091f5f3138b8cd40bc3e114258dd68ddf/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Simple HttpServer</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 28 May 2012</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 0.1</li>
                      
                
                    
      
                  </ul>
      </div>

            <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                                    <h3>Simple HttpServer</h3>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Home">Home</a>
            </li>
                  <li class="none">
                          <a href="api.html" title="APIs">APIs</a>
            </li>
                  <li class="none">
                          <a href="core.html" title="Core">Core</a>
            </li>
                  <li class="none">
                          <a href="demo.html" title="Demo">Demo</a>
            </li>
                  <li class="none">
                          <a href="benchmarks.html" title="Benchmarks">Benchmarks</a>
            </li>
                  <li class="none">
            <strong>For Developers</strong>
          </li>
          </ul>
                        <h3>Project Documentation</h3>
                  <ul>
                                                                                                                                                                                                                                                                                                              <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
          </ul>
                      
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
        <div id="bodyColumn"  class="span9" >
                                  
            <!--  --><!-- Copyright (c) 2012 Simone Tripodi (simonetripodi[at]apache[dot]org) --><!--  --><!-- Permission is hereby granted, free of charge, to any person obtaining --><!-- a copy of this software and associated documentation files (the --><!-- "Software"), to deal in the Software without restriction, including --><!-- without limitation the rights to use, copy, modify, merge, publish, --><!-- distribute, sublicense, and/or sell copies of the Software, and to --><!-- permit persons to whom the Software is furnished to do so, subject to --><!-- the following conditions: --><!--  --><!-- The above copyright notice and this permission notice shall be --><!-- included in all copies or substantial portions of the Software. --><!--  --><!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, --><!-- EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF --><!-- MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND --><!-- NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE --><!-- LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION --><!-- OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION --><!-- WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. --><!--  --><div class="section"><h2>Developing with Simple HttpServer APIs<a name="Developing_with_Simple_HttpServer_APIs"></a></h2><p>Developing web applications is quick and easy at the same moment, users just have to follow the steps below:</p><div class="section"><h3>Setup the dependencies<a name="Setup_the_dependencies"></a></h3><p>Let's add first the dependencies in the <tt>pom.xml</tt> file:</p><div class="source"><pre class="prettyprint">  &lt;dependencies&gt;
    ...
    &lt;dependency&gt;
      &lt;groupId&gt;org.99soft.shs&lt;/groupId&gt;
      &lt;artifactId&gt;shs-api&lt;/artifactId&gt;
      &lt;version&gt;0.1&lt;/version&gt;
      &lt;scope&gt;provided&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.99soft.shs&lt;/groupId&gt;
      &lt;artifactId&gt;shs-core&lt;/artifactId&gt;
      &lt;version&gt;0.1&lt;/version&gt;
    &lt;/dependency&gt;
    ...
  &lt;/dependencies&gt;</pre></div></div><div class="section"><h3>Implement an Apache Velocity RequestHandler<a name="Implement_an_Apache_Velocity_RequestHandler"></a></h3><p>We first need a <tt>ResponseBodyWriter</tt> implementation based on <i>Velocity</i>:</p><div class="source"><pre class="prettyprint">class VelocityResponseBodyWriter
    implements ResponseBodyWriter
{

    private final VelocityContext velocityContext;

    private final Template template;

    public VelocityResponseBodyWriter( VelocityContext velocityContext, Template template )
    {
        this.velocityContext = velocityContext;
        this.template = template;
    }

    @Override
    public String contentType()
    {
        return &quot;text/html;charset=UTF-8&quot;;
    }

    @Override
    public void write( WritableByteChannel output )
        throws IOException
    {
        StringWriter stringWriter = new StringWriter();

        template.merge( velocityContext, stringWriter );

        output.write( utf8ByteBuffer( stringWriter.toString() ) );
    }

}</pre></div><p>The we are ready to implement the <tt>RequestHandler</tt>:</p><div class="source"><pre class="prettyprint">class VelocityRequestHandler
    extends BaseRequestHandler
{

    public VelocityRequestHandler( File baseDir )
    {
        Properties properties = new Properties();
        properties.setProperty( &quot;file.resource.loader.path&quot;, baseDir.getAbsolutePath() );
        Velocity.init( properties );
    }

    @Override
    protected void get( Request request, Response response )
        throws IOException
    {
        VelocityContext velocityContext = new VelocityContext();
        velocityContext.put( &quot;request&quot;, request );

        Template template = Velocity.getTemplate( request.getPath() );

        response.setStatus( OK );
        response.setBody( new VelocityResponseBodyWriter( velocityContext, template ) );
    }

}</pre></div></div><div class="section"><h3>Implement the Velocity template<a name="Implement_the_Velocity_template"></a></h3><p>As you can read in the code below, the <tt>RequestHandler</tt> puts the <tt>Request</tt> instance in the <tt>VelocityContext</tt>, so we can play a little with data inside it to create a page:</p><div class="source"><pre class="prettyprint">&lt;html&gt;
  &lt;head&gt;&lt;title&gt;Request from $request.getClientHost()&lt;/title&gt;&lt;/head&gt;
  &lt;body&gt;
    &lt;div&gt;
      &lt;p&gt;HTTP Method: &lt;code&gt;$request.getMethod()&lt;/code&gt;&lt;/p&gt;
      #foreach( $header in $request.getHeaders().getAllKeys() )
      &lt;p&gt;$header:#foreach( $headerValue in $request.getHeaders().getValues( $header ) ) &lt;code&gt;$headerValue&lt;/code&gt;#end&lt;/p&gt;
      #end
      &lt;p&gt;Session ID: &lt;code&gt;$request.getSession().getId()&lt;/code&gt;&lt;/p&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div></div><div class="section"><h3>Implement the main launcher<a name="Implement_the_main_launcher"></a></h3><p>Now that all pieces have been set-up, all that is missing is a main entry point to launch the server</p><div class="source"><pre class="prettyprint">class Main
{

    private static Logger logger = LoggerFactory.getLogger( Main.class );

    /**
     * let's simplify and assume the *FromArgs( args ) method implemented somewhere else
     */
    public static void main( String[] args )
    {
        final File siteDir = siteDirFromArgs( args );

        final HttpServer httpServer = new SimpleHttpServer();
        try
        {
            httpServer.init( new AbstractHttpServerConfiguration()
            {

                @Override
                protected void configure()
                {
                    bindServerToHost( hostFromArgs( args ) );
                    bindServerToPort( portFromArgs( args ) );
                    serveRequestsWithThreads( threadsFromArgs( args ) );
                    sessionsHaveMagAge( sessionMaxAgeFromArgs( args ) );
                    keepAliveConnectionsHaveTimeout( keepAliveTimeOutFromArgs( args ) );

                    serve( &quot;*.vm&quot; ).with( new VelocityRequestHandler( siteDir ) );
                    when( NOT_FOUND ).serve( new File( siteDir, &quot;404.html&quot; ) );
                    when( INTERNAL_SERVER_ERROR ).serve( new File( siteDir, &quot;500.html&quot; ) );
                }

            } );
        }
        catch ( Throwable cause )
        {
            logger.error( &quot;Server cannot be initialized&quot;, cause );
            System.exit( 1 );
        }

        Runtime.getRuntime().addShutdownHook( new Thread()
        {

            public void run()
            {
                try
                {
                    httpServer.stop();
                }
                catch ( ShutdownException e )
                {
                    logger.error( &quot;Execution terminated with errors&quot;, e );
                }
            }
        }

        try
        {
            httpServer.start();
        }
        catch ( RunException se )
        {
            logger.error( &quot;Server cannot be started&quot;, se );
            System.exit( 1 );
        }
    }

}</pre></div><p>That's all! You can now run your Apache Velocity based dynamic site! :)</p></div></div><div class="section"><h2>Rebuild Simple HttpServer from scratch<a name="Rebuild_Simple_HttpServer_from_scratch"></a></h2><p>Users that want to hack the original source code, need:</p><ul><li>A <a class="externalLink" href="http://git-scm.com/">Git</a> client;</li><li><a class="externalLink" href="http://maven.apache.org/">Apache Maven</a> v3.0.X;</li><li>Their preferred IDE - I developed SHS using Eclipse, but it's not a constraint.</li></ul><p>Once cloned the project:</p><div><pre>git clone git@github.com:simonetripodi/shs.git</pre></div><p>go to the clone location</p><div><pre>cd shs</pre></div><p>and launch the Maven packaging:</p><div><pre>mvn package</pre></div><p>Maven will build the three main modules: the APIs, the Core implementation and the Simple Demo</p><div><pre>[INFO] Reactor Build Order:
[INFO] 
[INFO] Simple HttpServer
[INFO] Simple HttpServer :: APIs
[INFO] Simple HttpServer :: Core implementation
[INFO] Simple HttpServer :: Simple Demo
[INFO]</pre></div><p>The APIs and the Core implementation will be packaged in <tt>jar</tt> artifacts, the Simple Demo targets instead are <tt>tar.gz</tt> and <tt>zip</tt> assemblies that contain a self-contained application with the embedded Web server.</p></div>
                  </div>
            </div>
      
    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span16">Copyright &copy;                    2012
                        <a href="http://people.apache.org/~simonetripodi/">Simone Tripodi</a>.
            All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
